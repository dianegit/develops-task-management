name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Extract metadata
        id: meta
        run: |
          echo "version=sha-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/taskmanager-backend:${{ steps.meta.outputs.version }}
            ${{ secrets.ACR_LOGIN_SERVER }}/taskmanager-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.date }}
            VCS_REF=${{ github.sha }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/taskmanager-frontend:${{ steps.meta.outputs.version }}
            ${{ secrets.ACR_LOGIN_SERVER }}/taskmanager-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ steps.meta.outputs.date }}
            VCS_REF=${{ github.sha }}

      - name: Scan backend image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.ACR_LOGIN_SERVER }}/taskmanager-backend:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-backend-results.sarif'

      - name: Scan frontend image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.ACR_LOGIN_SERVER }}/taskmanager-frontend:${{ steps.meta.outputs.version }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'

      - name: Upload Trivy backend results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-backend-results.sarif'
          category: 'trivy-backend'

      - name: Upload Trivy frontend results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-frontend-results.sarif'
          category: 'trivy-frontend'

  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: production
      url: http://${{ steps.get-ip.outputs.vm_ip }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Ansible
        run: |
          pip install ansible
          ansible-galaxy collection install azure.azcollection
          ansible-galaxy collection install community.docker
          pip install -r https://raw.githubusercontent.com/ansible-collections/azure/dev/requirements-azure.txt

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VM_PUBLIC_IP }} >> ~/.ssh/known_hosts

      - name: Create Ansible inventory
        run: |
          cat > ansible/inventory/hosts << EOF
          [app_servers]
          azure-vm ansible_host=${{ secrets.VM_PUBLIC_IP }} ansible_user=azureuser
          EOF

      - name: Run Ansible deployment
        working-directory: ./ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: False
          ACR_NAME: ${{ secrets.ACR_NAME }}
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          ansible-playbook playbooks/setup-server.yml -i inventory/hosts -v

      - name: Verify deployment
        run: |
          sleep 30
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:8000/health || exit 1
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:3000 || exit 1

      - name: Get VM IP
        id: get-ip
        run: echo "vm_ip=${{ secrets.VM_PUBLIC_IP }}" >> $GITHUB_OUTPUT

  post-deployment:
    name: Post-Deployment Tests
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run smoke tests
        run: |
          echo "Running smoke tests against http://${{ secrets.VM_PUBLIC_IP }}"
          
          # Test frontend
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:3000 || exit 1
          
          # Test backend health
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:8000/health || exit 1
          
          # Test API docs
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:8000/api/docs || exit 1

      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "Frontend: http://${{ secrets.VM_PUBLIC_IP }}:3000"
          echo "Backend: http://${{ secrets.VM_PUBLIC_IP }}:8000"
