name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VM
        uses: appleboy/ssh-action@v1.0.0
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          VM_IP: ${{ secrets.VM_PUBLIC_IP }}
        with:
          host: ${{ secrets.VM_PUBLIC_IP }}
          username: azureuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 30m
          command_timeout: 30m
          envs: DB_USER,DB_PASSWORD,DB_NAME,SECRET_KEY,VM_IP
          script: |
            set -e
            
            echo "üì¶ Starting deployment..."
            
            # Navigate to app directory
            cd ~/develops-task-management
            
            # Pull latest code
            echo "üîÑ Pulling latest code from GitHub..."
            git pull origin main
            
            # Update CORS_ORIGINS in docker-compose.yml
            echo "‚öôÔ∏è  Updating configuration..."
            sed -i "s|CORS_ORIGINS:.*|CORS_ORIGINS: '[\"http://$VM_IP:3000\",\"http://$VM_IP\"]'|g" docker-compose.yml
            
            # Update environment variables in docker-compose.yml
            sed -i "s|POSTGRES_USER:.*|POSTGRES_USER: $DB_USER|g" docker-compose.yml
            sed -i "s|POSTGRES_PASSWORD:.*|POSTGRES_PASSWORD: $DB_PASSWORD|g" docker-compose.yml
            sed -i "s|POSTGRES_DB:.*|POSTGRES_DB: $DB_NAME|g" docker-compose.yml
            sed -i "s|DATABASE_URL:.*|DATABASE_URL: postgresql://$DB_USER:$DB_PASSWORD@postgres:5432/$DB_NAME|g" docker-compose.yml
            sed -i "s|SECRET_KEY:.*|SECRET_KEY: $SECRET_KEY|g" docker-compose.yml
            
            # Stop existing containers
            echo "üõë Stopping existing containers..."
            sudo docker-compose down
            
            # Build and start services
            echo "üöÄ Building and starting services..."
            sudo docker-compose up -d --build
            
            # Wait for services to start
            echo "‚è≥ Waiting for services to initialize..."
            sleep 10
            
            # Check service status
            echo "‚úÖ Deployment complete!"
            sudo docker-compose ps
            
            echo "üåê Application accessible at: http://$VM_IP:3000"

      - name: Verify deployment
        run: |
          echo "Waiting for services to fully start..."
          sleep 30
          echo "Checking application health..."
          curl -f http://${{ secrets.VM_PUBLIC_IP }}:3000 || echo "‚ö†Ô∏è Frontend check failed"
          echo "‚úÖ Deployment verification complete!"
